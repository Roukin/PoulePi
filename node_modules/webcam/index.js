var exec = require('child_process').exec;
var async = require('async');
var fs = require('fs');

var resolution = "640x480";
function Webcam(devPath, storageDir){
    this.dev = devPath;
    this.storageDir = storageDir;
}






Webcam.prototype.capture = function (callback){
	var date = new Date().toISOString();
	var imageFilename = "snap"+date+".jpg";
	var imagePath = this.storageDir + "/"+ imageFilename;
    console.log('capture  appelée pour '+this.dev);
    var stdout = exec( "fswebcam -q -S 1 --font /usr/share/fonts/truetype/freefont/FreeSans.ttf  --bottom-banner -d " + this.dev + " -r " + resolution + " " + imagePath,
    	function (error, stdout, stderr) {	
		    fs.stat(imagePath, function(err, stats){
			    if (err || !stats.isFile() ){
					console.log('fs.open : file '+imagePath+' does not exist'+err+stats);
			    }else {			    	
			    	console.log('image capturée: ' + imageFilename + err+stats);			    	
			      	exec("jpegoptim -q --all-progressive --strip-all " + imagePath,function (error, stdout, stderr) {	});
			      	callback(imageFilename); 
		    	}
		    });
    	});    
}


 module.exports = Webcam;